# app.py
import streamlit as st
import matplotlib
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import pandas as pd
import numpy as np
import os

# Êñ∞Â¢ûÔºöË†üÁá≠ÂúñÂ•ó‰ª∂
import mplfinance as mpf

from stock import fetch_stock_data

# ========== ‚úÖ ‰Ω†ÁöÑ„ÄåËºâÂÖ•‰∏≠ÊñáÂ≠óÂûã„Äç‰øùÊåÅ‰∏çÂãï ==========
font_path = os.path.join(".streamlit", "fonts", "NotoSansTC-Regular.otf")
if os.path.exists(font_path):
    font_prop = fm.FontProperties(fname=font_path)
    st.write(f"‚úÖ ÊàêÂäüËºâÂÖ•‰∏≠ÊñáÂ≠óÂûãÔºö{font_prop.get_name()}")
else:
    font_prop = None
    st.warning("‚ö†Ô∏è Êâæ‰∏çÂà∞‰∏≠ÊñáÂ≠óÂûãÔºåÂúñË°®‰∏≠ÊñáÂ≠óÂèØËÉΩÁÑ°Ê≥ïÊ≠£Á¢∫È°ØÁ§∫„ÄÇ")
# ===================================

st.set_page_config(layout="wide")
st.title("üìà Âè∞ËÇ°ÊäÄË°ìÊåáÊ®ôË¶ñË¶∫ÂåñÂπ≥Âè∞")

# === Sidebar input ===
st.sidebar.header("Ëº∏ÂÖ•ÂèÉÊï∏")
stock_no = st.sidebar.text_input("ËÇ°Á•®‰ª£ËôüÔºàÂ¶Ç 1303Ôºâ", value="1303")

col1, col2 = st.sidebar.columns(2)
start_year = col1.number_input("Ëµ∑ÂßãÂπ¥‰ªΩÔºàË•øÂÖÉÔºâ", value=2025, step=1)
start_month = col2.selectbox("Ëµ∑ÂßãÊúà‰ªΩ", list(range(1, 13)), index=0)

col3, col4 = st.sidebar.columns(2)
end_year = col3.number_input("ÁµêÊùüÂπ¥‰ªΩÔºàË•øÂÖÉÔºâ", value=2025, step=1)
end_month = col4.selectbox("ÁµêÊùüÊúà‰ªΩ", list(range(1, 13)), index=1)

indicator = st.sidebar.selectbox("ÊäÄË°ìÊåáÊ®ô", ["Â∏ÉÊûóÂ∏∂", "ÁßªÂãïÂπ≥ÂùáÁ∑ö", "Â∏ÉÊûóÂ∏∂ + ÁßªÂãïÂπ≥ÂùáÁ∑ö"])
chart_type = st.sidebar.selectbox("ÂúñË°®È°ûÂûã", ["Ë†üÁá≠Âúñ", "ÊäòÁ∑öÂúñ"])  # ÂèØÂàáÊèõ

# ‚úÖ Êñ∞Â¢ûÔºöË≥áÊñôÈ†ªÁéá
freq_label = st.sidebar.selectbox("Ë≥áÊñôÈ†ªÁéá", ["ÊØèÂ§©", "ÊØèÈÄ±", "ÊØèÊúà", "ÊØèÂ∞èÊôÇ", "ÊØè15ÂàÜÈêò"], index=0)
FREQ_MAP = {"ÊØèÂ§©": "D", "ÊØèÈÄ±": "W", "ÊØèÊúà": "M", "ÊØèÂ∞èÊôÇ": "H", "ÊØè15ÂàÜÈêò": "15min"}
rule = FREQ_MAP[freq_label]

# === Â∑•ÂÖ∑ÂáΩÂºèÔºöË®àÁÆó RSI / MACD ===
def add_rsi_macd(df: pd.DataFrame) -> pd.DataFrame:
    # RSI(14) - Wilder
    delta = df["Close"].diff()
    gain = delta.clip(lower=0)
    loss = -delta.clip(upper=0)
    window = 14
    avg_gain = gain.ewm(alpha=1 / window, min_periods=window, adjust=False).mean()
    avg_loss = loss.ewm(alpha=1 / window, min_periods=window, adjust=False).mean().replace(0, 1e-10)
    rs = avg_gain / avg_loss
    df["RSI"] = 100 - (100 / (1 + rs))

    # MACD(12,26,9)
    ema12 = df["Close"].ewm(span=12, adjust=False).mean()
    ema26 = df["Close"].ewm(span=26, adjust=False).mean()
    df["MACD"] = ema12 - ema26
    df["MACD_signal"] = df["MACD"].ewm(span=9, adjust=False).mean()
    df["MACD_hist"] = df["MACD"] - df["MACD_signal"]
    return df

# ‚úÖ Êñ∞Â¢ûÔºöOHLCV ÈáçÊé°Ê®£
def resample_ohlcv(df: pd.DataFrame, rule: str) -> tuple[pd.DataFrame, bool]:
    """
    ÂõûÂÇ≥ (resampled_df, used_original)„ÄÇ
    - Ëã•ÂéüÂßãË≥áÊñôÁÇ∫Êó•È†ªÔºå‰∏îÈÅ∏ÊìáÂ∞èÊôÇ/15ÂàÜÔºåÂâáÂõûÂÇ≥ (Âéü df, True) ‰∏¶Áî±ÂëºÂè´Á´ØÊèêÁ§∫ fallback„ÄÇ
    """
    # Ê™¢Êü•ÊòØÂê¶ÊúâÊôÇÈñìÁ¥¢Âºï
    if not np.issubdtype(df.index.dtype, np.datetime64):
        if "Date" in df.columns:
            df = df.copy()
            df["Date"] = pd.to_datetime(df["Date"])
            df = df.set_index("Date").sort_index()
        else:
            return df, True  # Ê≤íÊó•ÊúüÂèØÁî®ÔºåÁõ¥Êé•ËøîÂõû

    # Âà§Êñ∑ÂéüÂßãÈ†ªÁéáÊòØÂê¶Ëá≥Â∞ëÊó•ÂÖß
    diffs = df.index.to_series().diff().dropna()
    min_step = diffs.min() if not diffs.empty else pd.Timedelta("0s")

    # Â¶ÇÊûú‰ΩøÁî®ËÄÖÈÅ∏„ÄåH/15min„Äç‰ΩÜË≥áÊñôÊúÄÂ∞èÈñìË∑ù >= 1 Â§©ÔºåÂ∞±ÁÑ°Ê≥ïÂêë‰∏ãÂèñÊ®£
    if rule in ("H", "15min") and (min_step >= pd.Timedelta("1D")):
        return df, True  # ‰ΩøÁî®ÂéüÂßãË≥áÊñôÔºàfallbackÔºâ

    agg = {}
    for col, fn in {"Open": "first", "High": "max", "Low": "min", "Close": "last"}.items():
        if col in df.columns:
            agg[col] = fn
    if "Volume" in df.columns:
        agg["Volume"] = "sum"

    res = df.resample(rule, label="right", closed="right").agg(agg)
    # Á†çÊéâÁÑ°Ê≥ïÂΩ¢ÊàêÂÆåÊï¥ OHLC ÁöÑÂàó
    for c in ("Open", "High", "Low", "Close"):
        if c in res.columns:
            res = res[res[c].notna()]
    return res, False  # ÊàêÂäüÈáçÊé°Ê®£

# === Main action ===
if st.sidebar.button("ÈñãÂßãÁπ™Ë£Ω"):
    st.write(f"üëâ Êü•Ë©¢ÂèÉÊï∏ÔºöËÇ°Á•®‰ª£Ëôü={stock_no}, Ëµ∑={start_year}/{start_month}, ËøÑ={end_year}/{end_month}ÔºåÈ†ªÁéá={freq_label}")
    st.info("Ê≠£Âú®ÊäìÂèñË≥áÊñôÔºåË´ãÁ®çÂÄô...")
    df = fetch_stock_data(stock_no, start_year, start_month, end_year, end_month)

    if df is None or df.empty:
        st.error("Êâæ‰∏çÂà∞Ë≥áÊñôÔºåË´ãÁ¢∫Ë™çËÇ°Á•®‰ª£ËôüËàáÊôÇÈñìÁØÑÂúç„ÄÇ")
        st.stop()

    # ÂÖàÈáçÊé°Ê®£Âà∞ÊåáÂÆöÈ†ªÁéá
    df_resampled, used_original = resample_ohlcv(df, rule)
    if used_original and rule in ("H", "15min"):
        st.warning("‚ö†Ô∏è ÂéüÂßãË≥áÊñôÂÉÖÊúâÊó•È†ªÔºåÁÑ°Ê≥ïÁî¢ÁîüÊØèÂ∞èÊôÇ/ÊØè15ÂàÜÈêòË≥áÊñôÔºåÂ∑≤ÊîπÁî®„ÄéÊØèÂ§©„Äè„ÄÇ")
        rule = "D"  # Êõ¥Êñ∞ ruleÔºåÂÉÖÁî®ÊñºÈ°ØÁ§∫
    df = df_resampled

    # ÂøÖË¶ÅÊ¨Ñ‰Ωç
    needed_cols = {"Open", "High", "Low", "Close"}
    if not needed_cols.issubset(df.columns):
        st.error(f"Áº∫Â∞ëÂøÖË¶ÅÊ¨Ñ‰ΩçÔºö{needed_cols - set(df.columns)}")
        st.stop()

    has_volume = "Volume" in df.columns

    # Ë®àÁÆóÊåáÊ®ôÔºà‰ª•ÈáçÊé°Ê®£ÂæåÁöÑË≥áÊñôÁÇ∫Âü∫Á§éÔºâ
    show_ma = ("ÁßªÂãïÂπ≥ÂùáÁ∑ö" in indicator) or ("Â∏ÉÊûóÂ∏∂ + ÁßªÂãïÂπ≥ÂùáÁ∑ö" in indicator)
    show_bb = ("Â∏ÉÊûóÂ∏∂" in indicator) or ("Â∏ÉÊûóÂ∏∂ + ÁßªÂãïÂπ≥ÂùáÁ∑ö" in indicator)

    if show_ma:
        df["SMA20"] = df["Close"].rolling(20).mean()
        df["SMA60"] = df["Close"].rolling(60).mean()

    if show_bb:
        df["BB_MA"] = df["Close"].rolling(20).mean()
        df["BB_STD"] = df["Close"].rolling(20).std()
        df["UpperB"] = df["BB_MA"] + 2 * df["BB_STD"]
        df["LowerB"] = df["BB_MA"] - 2 * df["BB_STD"]

    df = add_rsi_macd(df)

    st.success(f"‚úÖ Êé°Áî®È†ªÁéáÔºö{freq_label}ÔºàÂØ¶ÈöõÂàóÊï∏Ôºö{len(df)}Ôºâ")
    with st.expander("Êü•ÁúãË≥áÊñôÔºàÊúÄÂæå 30 Á≠ÜÔºâ"):
        st.dataframe(df.tail(30), use_container_width=True)

    # =======================
    # ÊäòÁ∑öÂúñÔºàÊ∑±Ëâ≤ÔºâÔºã Volume Â≠êÂúñ Ôºã RSI/MACD Á¨¨‰∏âÂ≠êÂúñ
    # =======================
    if chart_type == "ÊäòÁ∑öÂúñ":
        plt.style.use("dark_background")  # Ê∑±Ëâ≤ËÉåÊôØ

        # Èù¢ÊùøÊï∏ÔºöÊúâ Volume ‚Üí ‰∏âÂÄãÂ≠êÂúñÔºõÊ≤íÊúâ Volume ‚Üí ÂÖ©ÂÄãÂ≠êÂúñÔºàÂÉπÊ†º + RSI/MACDÔºâ
        if has_volume:
            fig = plt.figure(figsize=(14, 9))
            gs = fig.add_gridspec(3, 1, height_ratios=[3, 1, 1], hspace=0.1)
            ax_price = fig.add_subplot(gs[0, 0])
            ax_vol   = fig.add_subplot(gs[1, 0], sharex=ax_price)
            ax_ind   = fig.add_subplot(gs[2, 0], sharex=ax_price)
        else:
            fig = plt.figure(figsize=(14, 8))
            gs = fig.add_gridspec(2, 1, height_ratios=[3, 1], hspace=0.1)
            ax_price = fig.add_subplot(gs[0, 0])
            ax_ind   = fig.add_subplot(gs[1, 0], sharex=ax_price)
            ax_vol = None

        # ‰∏ªÂúñÔºöÊî∂Áõ§ÂÉπ + MA/BB
        ax_price.plot(df.index, df["Close"], label="Êî∂Áõ§ÂÉπ", color="#FFFFFF", linewidth=1.2)
        if show_ma:
            ax_price.plot(df.index, df["SMA20"], label="20Êó•ÂùáÁ∑ö", color="#4FC3F7", linestyle="--")
            ax_price.plot(df.index, df["SMA60"], label="60Êó•ÂùáÁ∑ö", color="#81C784", linestyle="--")
        if show_bb:
            ax_price.plot(df.index, df["UpperB"], label="‰∏äÂ∏ÉÊûóÂ∏∂", color="#EF5350", linestyle=":")
            ax_price.plot(df.index, df["LowerB"], label="‰∏ãÂ∏ÉÊûóÂ∏∂", color="#EF5350", linestyle=":")

        ax_price.set_title(f"{stock_no} ÊäÄË°ìÂàÜÊûêÔºàÊäòÁ∑öÂúñ / {freq_label}Ôºâ", fontproperties=font_prop)
        ax_price.set_ylabel("ËÇ°ÂÉπ", fontproperties=font_prop)
        ax_price.grid(True, alpha=0.25, linestyle=":")
        ax_price.legend(facecolor="#111", edgecolor="#333", labelcolor="w", prop=font_prop)

        # Êàê‰∫§ÈáèÂ≠êÂúñÔºàÁ¥ÖÊº≤Á∂†Ë∑åÔºâ
        if has_volume:
            up = df["Close"] >= df["Open"]
            vol_colors = np.where(up, "#FF5252", "#00C853")
            ax_vol.bar(df.index, df["Volume"], color=vol_colors, width=0.8)
            ax_vol.set_ylabel("Êàê‰∫§Èáè", fontproperties=font_prop)
            ax_vol.grid(True, alpha=0.2, linestyle=":")

        # Á¨¨‰∏âÂ≠êÂúñÔºöRSI + MACDÔºàÂêå‰∏ÄÈù¢ÊùøÔºõRSI Â∑¶Ëª∏„ÄÅMACD Âè≥Ëª∏Ôºâ
        ax_ind.set_ylabel("RSI(14)", fontproperties=font_prop, color="#80CBC4")
        ax_ind.plot(df.index, df["RSI"], color="#80CBC4", label="RSI(14)", linewidth=1.0)
        ax_ind.axhline(70, color="#B0BEC5", linestyle="--", linewidth=0.8)
        ax_ind.axhline(30, color="#B0BEC5", linestyle="--", linewidth=0.8)
        ax_ind.set_ylim(0, 100)
        ax_ind.grid(True, alpha=0.2, linestyle=":")

        ax_macd = ax_ind.twinx()
        hist_colors = np.where(df["MACD_hist"] >= 0, "#FF7043", "#26A69A")
        ax_macd.bar(df.index, df["MACD_hist"], color=hist_colors, width=0.8, alpha=0.5, label="MACD Hist")
        ax_macd.plot(df.index, df["MACD"], color="#FFA726", linewidth=1.0, label="MACD")
        ax_macd.plot(df.index, df["MACD_signal"], color="#FFFFFF", linewidth=1.0, label="Signal")
        ax_macd.set_ylabel("MACD", fontproperties=font_prop)

        # Ê®ôÁ±§ËàáÂàªÂ∫¶Ëâ≤
        for ax in [ax_price, ax_ind] + ([ax_vol] if ax_vol is not None else []):
            ax.tick_params(colors="w")
        ax_macd.tick_params(colors="w")
        plt.xticks(rotation=30, color="w")
        plt.yticks(color="w")

        st.pyplot(fig)

    # =======================
    # Ë†üÁá≠ÂúñÔºàÊ∑±Ëâ≤ nightcloudsÔºâÔºã Volume Èù¢Êùø Ôºã RSI/MACD Á¨¨‰∏âÈù¢Êùø
    # =======================
    else:
        mc = mpf.make_marketcolors(
            up="r", down="g",
            edge="inherit", wick="inherit", volume="inherit",
        )
        s = mpf.make_mpf_style(base_mpf_style="nightclouds", marketcolors=mc, gridstyle=":")
        addplots = []

        # Â∏ÉÊûóÂ∏∂Áï´Âú®‰∏ªÂúñ
        if show_bb:
            addplots += [
                mpf.make_addplot(df["UpperB"], color="#EF5350", panel=0),
                mpf.make_addplot(df["LowerB"], color="#EF5350", panel=0),
            ]

        # Á¨¨‰∏âÈù¢ÊùøÔºöRSI + MACDÔºàÂú®Âêå‰∏Ä panel=2Ôºâ
        addplots += [
            mpf.make_addplot(df["RSI"], panel=2, color="#80CBC4"),
            mpf.make_addplot(pd.Series(70, index=df.index), panel=2, color="#B0BEC5", linestyle="--"),
            mpf.make_addplot(pd.Series(30, index=df.index), panel=2, color="#B0BEC5", linestyle="--"),
        ]
        # MACD hist + MACD + Signal
        macd_colors = ["#FF7043" if v >= 0 else "#26A69A" for v in df["MACD_hist"]]
        addplots += [
            mpf.make_addplot(df["MACD_hist"], type="bar", panel=2, color=macd_colors, alpha=0.5),
            mpf.make_addplot(df["MACD"], panel=2, color="#FFA726"),
            mpf.make_addplot(df["MACD_signal"], panel=2, color="#FFFFFF"),
        ]

        mav = (20, 60) if show_ma else None

        fig, axes = mpf.plot(
            df,
            type="candle",
            mav=mav,
            addplot=addplots,
            volume=("Volume" in df.columns),
            style=s,
            figsize=(14, 9),
            panel_ratios=(3, 1, 1),
            returnfig=True
        )
        # Áî®‰Ω†ÁöÑÂ≠óÂûãÁâ©‰ª∂Ë®≠Ê®ôÈ°å/Ê®ôÁ±§Ôºà‰∏çÊîπ‰Ω†ÁöÑËºâÂÖ•ÊñπÂºèÔºâ
        try:
            axes[0].set_title(f"{stock_no} ÊäÄË°ìÂàÜÊûêÔºàË†üÁá≠Âúñ / {freq_label}Ôºâ", fontproperties=font_prop)
            axes[0].set_ylabel("ËÇ°ÂÉπ", fontproperties=font_prop)
            if "Volume" in df.columns:
                axes[1].set_ylabel("Êàê‰∫§Èáè", fontproperties=font_prop)
            axes[-1].set_ylabel("RSI / MACD", fontproperties=font_prop)
        except Exception:
            pass

        st.pyplot(fig)
